name: Android CI

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ main
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  # –°–∏—Å—Ç–µ–º–Ω—ã–π SDK —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ ubuntu-latest
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

jobs:
  build:
    name: Build, Lint, Tests & APKs
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        include:
          - variantName: Debug
            apkPath: app/build/outputs/apk/debug/app-debug.apk
          - variantName: Release
            apkPath: app/build/outputs/apk/release/app-release-unsigned.apk

    steps:
      # 1) –ö–ª–æ–Ω–∏—Ä—É–µ–º
      - name: üì• Checkout
        uses: actions/checkout@v4

      # 2) JDK 17
      - name: ‚öôÔ∏è Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      # 3) –î–æ–±–∞–≤–ª—è–µ–º Android SDK –≤ PATH
      - name: üõ† Setup Android SDK tools
        run: |
          echo "PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/cmdline-tools/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH" >> $GITHUB_ENV

      # 4) –ü—Ä–∏–Ω–∏–º–∞–µ–º –ª–∏—Ü–µ–Ω–∑–∏–∏
      - name: ‚úÖ Accept SDK licenses
        run: yes | sdkmanager --licenses

      # 5) –ó–∞–ø—É—Å–∫–∞–µ–º lint, unit-—Ç–µ—Å—Ç—ã –∏ —Å–±–æ—Ä–∫—É
      - name: üîç Lint & üß™ Unit tests & üèó Assemble ${{ matrix.variantName }}
        run: |
          ./gradlew clean \
            lint${{ matrix.variantName }} \
            test${{ matrix.variantName }}UnitTest \
            assemble${{ matrix.variantName }} \
            --stacktrace

      # 6) –ó–∞–≥—Ä—É–∂–∞–µ–º APK –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
      - name: ‚òÅÔ∏è Upload ${{ matrix.variantName }} APK
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.variantName | downcase }}.apk
          path: ${{ matrix.apkPath }}

  notify:
    name: Telegram Notification on Failure
    runs-on: ubuntu-latest
    needs: build
    if: failure()

    steps:
      - name: üö® Send Telegram alert
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode=Markdown \
            -d text="‚ùå *CI Failed* –≤ `${{ github.repository }}`%0A‚Ä¢ Job: `${{ needs.build.result }}`%0A‚Ä¢ Workflow: `${{ github.workflow }}`%0A[Open run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
